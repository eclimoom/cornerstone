<!DOCTYPE HTML>
<html>
<head>
</head>
<body>
<div class="container">

    <div class="row" style="padding-top: 20px;">
        <div class="col-xs-10">
            <!-- note we disable selection on the top most div -->
            <div style="width:512px;height:512px;position:relative;color: white;"
                 class="cornerstone-enabled-image"
                 oncontextmenu="return false"
                 unselectable='on'
                 onselectstart='return false;'
                 onmousedown='return false;'>
                <div id="dicomImage"
                     style="width:512px;height:512px;top:0px;left:0px; position:absolute">
                </div>
                <div id="bottomleft" style="width:100px;height:30px;bottom:0px;left:0px; position:absolute">

                </div>
            </div>
        </div>
    </div>
</div>
</body>

<!-- cornerstone depends on jQuery so it must be loaded first-->
<script src="../jquery.min.js"></script>

<!-- include the cornerstone library -->
<script src="../../dist/cornerstone.js"></script>

<!-- include special code for these examples which provides images -->
<script src="../petctImageIdLoader.js"></script>
<script src="../petctMetaDataProvider.js"></script>

<script>

    $(document).ready(function() {
        // Enable the dicomImage element
        var element = $('#dicomImage').get(0);
        cornerstone.enable(element);

        // JSON with all layers to be loaded
        // The `name` option is used only by this example and
        // cornerstone doesn't even know that it exists.
        // You can add any option you want to `options` object.
        var layers = [
            {
                imageId: 'ct://1',
                options: {
                    name: 'CT',
                    colormap: 'hotIron'
                }
            }
        ];

        // This is the main function responsible for loading all layers
        // This method will wait for all images to be loaded (`loadImages`)
        // before adding the layers
        function loadLayers() {
            loadImages().then(function(image) {
                // var images = Array.prototype.slice.call(arguments);

                var layer = {
                    imageId: 'ct://1',
                    options: {
                        name: 'CT',
                        colormap: 'jet'
                    }
                };
                var layerId = cornerstone.addLayer(element, image, layer.options);

                cornerstone.updateImage(element);
                console.log('Layer ' + index + ': ' + layerId);

            });
        }

        // This method loads the image of each layer and resolve the 
        // promise only after getting all of them loaded
        // https://api.jquery.com/jquery.when/
        function loadImages() {
            var promises = [];

            layers.forEach(function(layer) {
                var loadPromise = cornerstone.loadImage(layer.imageId);
                promises.push(loadPromise);
            });

            return $.when.apply($, promises);
        }

        // Select the right layer in the dropdown
        function updateSelectedLayer(layerId) {
            var $layers = $('#layers');
            var currentLayerId = $layers.val();

            if(currentLayerId !== layerId) {
                $layers.val(layerId);
                $layers.trigger('change');
            }
        }



        // Populate colormap dropdown with all the default ones
        function fillColormapsList() {
            var $dropdown = $('#colormaps');
            var colormapsList = cornerstone.colors.getColormapsList();

            var addOption = function(id, name) {
                var $option = $('<option></option>')
                    .val(id)
                    .text(name)

                $dropdown.append($option);
            }

            colormapsList.forEach(function(colormapItem) {
                addOption(colormapItem.id, colormapItem.name);
            });
        }

        //
        $('#dicomImage').mousedown(function (e) {
            var lastX = e.pageX;
            var lastY = e.pageY;

            var mouseButton = e.which;

            $(document).mousemove(function (e) {
                var deltaX = e.pageX - lastX
                var deltaY = e.pageY - lastY;
                lastX = e.pageX;
                lastY = e.pageY;

                e.stopPropagation();
                var viewport = cornerstone.getViewport(element);

                if (mouseButton == 1) {
                    viewport.voi.windowWidth += (deltaX / viewport.scale);
                    viewport.voi.windowCenter += (deltaY / viewport.scale);
                    cornerstone.setViewport(element, viewport);
                    $('#bottomleft').text("WW/WL:" + Math.round(viewport.voi.windowWidth) + "/" + Math.round(viewport.voi.windowCenter));
                }
            });

            $(document).mouseup(function (e) {
                $(document).unbind('mousemove');
                $(document).unbind('mouseup');
            });
        });

        // Start point to load all layers and colormaps and
        // also attach a click listener to each tool
        loadLayers();
        fillColormapsList();
    });

</script>
</html>
